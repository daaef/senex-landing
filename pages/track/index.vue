<template>
  <section class="section">
    <div class="container wrapper">
      <div class="columns">
        <div class="column is-6 is-4-widescreen is-offset-3 is-offset-4-widescreen is-vcentered">
          <div class="boxp">
            <p class="has-text-weight-semibold p-heading has-text-centered">
              Tracking
              <span
                class="is-block has-text-centered has-text-weight-normal"
                style="font-size: 0.95rem;"
              >
                Track status of your transaction
              </span>
            </p>

            <div v-if="step === 'trackid'" class="trackid-wrapper">
              <form action="">
                <div class="card trackid-container" style="padding-top: 5rem; padding-bottom: 5rem;">
                  <div class="field">
                    <label for="" class="label has-text-weight-normal">Trade ID</label>
                    <p class="control">
                      <input
                        v-model="tradeId"
                        v-validate="'required|alpha_dash|length:12'"
                        type="text"
                        name="trade id"
                        class="input is-large"
                        placeholder="caJESHXlbaes"
                      >
                    </p>
                  </div>
                  <p v-show="errors.has('trade id')" class="help is-danger">
                    {{ errors.first('trade id') }}
                  </p>
                </div>
                <div class="button-container">
                  <button
                    class="button is-fullwidth track-button"
                    :class="{'is-loading': isLoading}"
                    @click.prevent="handleContinue"
                  >
                    Continue
                  </button>
                </div>
              </form>
              <div class="has-no-trade has-text-centered">
                <p>Haven't started your order?</p>
                <p>
                  <nuxt-link to="/" class="is-size-5 trade-link">
                    Start Transaction
                  </nuxt-link>
                </p>
              </div>
            </div>

            <div v-else-if="step === 'pinverification'" class="otpverification-wrapper">
              <div class="card otpverification-container">
                <p class="subheading has-text-centered">
                  Pin Verification
                </p>
                <p class="text-info has-text-centered">
                  Enter the pin for this transaction
                </p>
                <div class="columns is-mobile">
                  <div class="column is-3">
                    <input
                      ref="pin1"
                      v-model="pin1"
                      type="text"
                      class="input"
                      maxlength="1"
                      @keyup="handleKeyUp($event, 1)"
                    >
                  </div>
                  <div class="column is-3">
                    <input
                      ref="pin2"
                      v-model="pin2"
                      type="text"
                      class="input"
                      maxlength="1"
                      @keyup="handleKeyUp($event, 2)"
                    >
                  </div>
                  <div class="column is-3">
                    <input
                      ref="pin3"
                      v-model="pin3"
                      type="text"
                      class="input"
                      maxlength="1"
                      @keyup="handleKeyUp($event, 3)"
                    >
                  </div>
                  <div class="column is-3">
                    <input
                      ref="pin4"
                      v-model="pin4"
                      type="text"
                      class="input"
                      @keyup="handleKeyUp($event, 4)"
                    >
                  </div>
                </div>
                <div class="btn-container">
                  <button
                    ref="submitPin"
                    class="button"
                    :disabled="!pin1 || !pin2 || !pin3 || !pin4"
                    @click="handlePinSubmit"
                  >
                    Track
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</template>

<script>
import { mapState } from 'vuex'

const _ERR_FETCH_TRADE_ = "Couldn't fetch transaction; try again"
const _STR_INVALID_PIN_ = 'Invalid pin; please enter correct transaction pin'

export default {
  layout: 'blue',

  data() {
    return {
      isLoading: false,
      // tradeId: '',
      pin1: '',
      pin2: '',
      pin3: '',
      pin4: '',
      tradeData: null,

      // This is used to determine which section of the UI to show.
      // Valid values are trackid | pinverification
      step: 'trackid'
    }
  },

  head() {
    return {
      title: 'Track a Trade - SenexPAY',
      meta: [
        {
          hid: 'description',
          name: 'description',
          content:
            'SenexPAY Tracking helps you lookup the status of your transaction and enable you log complaints/inquiries about that transaction. Track your transaction now!'
        }
      ],
      link: [{ rel: 'canonical', href: 'https://www.senexpay.com/track' }]
    }
  },

  computed: {
    ...mapState({
      trade: state => state.trade.track.tradeId
    }),

    tradeId: {
      get() {
        return this.trade
      },
      set(value) {
        this.$store.commit('trade/SET_TRACK_TRADE_ID', value)
      }
    }
  },

  methods: {
    handleKeyUp(event, pinLevel /* 1,2,3,4 */) {
      if (event.key === 'Backspace' || event.key === 'Delete') {
        if (pinLevel === 1) {
          return
        }
        this.$refs[`pin${pinLevel - 1}`].focus()
      } else if (pinLevel === 4) {
        this.$refs.submitPin.focus()
      } else {
        this.$refs[`pin${pinLevel + 1}`].focus()
      }
    },

    handleContinue() {
      this.$validator.validateAll().then(async validated => {
        if (validated) {
          await this.getTrade()
          if (this.tradeData) {
            this.step = 'pinverification'
          }
        }
      })
    },

    async getTrade() {
      try {
        this.isLoading = true
        const resp = await this.$axios.get(`/trade/${this.tradeId}/`)
        this.tradeData = resp.data
      } catch (err) {
        this.$swal({
          title: '',
          type: 'error',
          position: 'top-end',
          text: _ERR_FETCH_TRADE_,
          timer: 5 * 1000,
          toast: true,
          showConfirmButton: false
        })
      } finally {
        this.isLoading = false
      }
    },

    handlePinSubmit() {
      const pin = `${this.pin1}${this.pin2}${this.pin3}${this.pin4}`
      if ('' + this.tradeData.pin === pin) {
        this.$store.commit('trade/SET_TRACK_TRADE_ID', this.tradeId)
        this.$router.replace({
          path: '/track/verify',
          query: {
            trade_id: this.tradeId
          }
        })
      } else {
        this.$swal({
          title: '',
          type: 'info',
          position: 'top-end',
          text: _STR_INVALID_PIN_,
          timer: 5 * 1000,
          toast: true,
          showConfirmButton: false
        })
      }
    }
  }
}
</script>

<style lang="scss" scoped>
@import '@/assets/scss/fonts.scss';

.is-vcentered {
  display: flex;
  -webkit-box-align: center;
  -ms-flex-align: center;
  align-items: center;
  height: 70vh;
}

.boxp {
  display: block;
  width: 100%;
}

div.wrapper {
  min-height: 480px;
  margin-bottom: 3rem;

  button:focus,
  input:focus,
  select:focus {
    outline: none;
    outline-style: none;
    box-shadow: none;
  }

  margin-top: 2rem;
  font-family: $font-avenir;

  p.p-heading {
    color: #254882;
    font-size: 1.7rem;
    margin-bottom: 1.5rem;
  }

  div.trackid-wrapper {
    label {
      color: #455e6f;
      font-family: $font-roboto;
    }

    div.trackid-container {
      padding: 3rem 2.5rem;
      box-shadow: 0px 1px 6px rgba(0, 0, 0, 0.161);
    }

    div.button-container {
      margin-top: 1rem;
      margin-bottom: 2rem;
      button.track-button {
        background-color: #254882;
        font-family: $font-avenir;
        color: #fff;
      }
    }

    div.has-no-trade {
      margin-top: 2.5rem;
      // margin-bottom: 10rem;
      color: #000000;
    }
  }

  div.otpverification-wrapper {
    font-family: $font-avenir;
    input {
      font-weight: bold;
      text-align: center;
    }

    div.otpverification-container {
      padding: 2rem 1.5rem;
      background-color: #fbfbfb;
      border-radius: 4px;

      p.subheading {
        text-align: center;
        color: #254882;
        margin: 0.8rem 0;
      }

      p.text-info {
        color: #d5d5d5;
        margin-bottom: 0.8rem;
      }

      div.btn-container {
        margin-top: 0.8rem;
        text-align: center;
        button {
          color: #ffffff;
          background-color: #254882;
        }
      }

      a.resend {
        display: block;
        margin-top: 1.2rem;
        text-align: center;
      }
    }
  }

  div.trade-status-wrapper {
    font-family: $font-avenir;

    div.trade-status-container {
      .subheading {
        text-align: center;
        color: #254882;
        padding: 1rem 0;
        font-size: 1.3rem;
      }

      .trade-info {
        padding: 1rem 0.7rem;
        .trade-info-item {
          margin: 0.7rem 0;
          .item-heading {
            color: #254882;
            margin-bottom: 0.5rem;
          }

          .item-res {
            color: #d5d5d5;
            word-wrap: break-word;
          }
        }
      }
    }
  }
}
</style>
